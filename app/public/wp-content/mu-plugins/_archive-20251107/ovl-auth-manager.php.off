<?php
/**
 * Plugin Name: OVL Auth Manager
 * Description: ログイン URL・リダイレクト・ゲート判定をシンプルに統合する MU プラグイン。
 */

if ( ! defined('ABSPATH') ) {
    exit;
}

if ( ! defined('OVL_LOGIN_PAGE') ) {
    define('OVL_LOGIN_PAGE', '/members/');
}
if ( ! defined('OVL_REGISTER_PAGE') ) {
    define('OVL_REGISTER_PAGE', '/member-register/');
}
if ( ! defined('OVL_MEMBER_GATE_PAGE') ) {
    define('OVL_MEMBER_GATE_PAGE', '/member-gate/');
}

/**
 * 必要に応じてデバッグログを残すヘルパ。
 */
function ovl_auth_log(string $channel, string $message, array $context = []): void {
    $enabled = defined('OVL_AUTH_LOG') ? (bool) OVL_AUTH_LOG : (defined('WP_DEBUG_LOG') && WP_DEBUG_LOG);
    if ( ! $enabled || ! function_exists('error_log') ) {
        return;
    }
    if ( $context ) {
        $json = function_exists('wp_json_encode')
            ? wp_json_encode($context, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE)
            : json_encode($context);
        if ( $json ) {
            $message .= ' ' . $json;
        }
    }
    error_log(sprintf('[OVL %s] %s', $channel, $message));
}

/**
 * 現在リクエストのパス（両端スラッシュなし）を取得。
 */
function ovl_auth_request_path(): string {
    $raw = isset($_SERVER['REQUEST_URI']) ? parse_url((string) $_SERVER['REQUEST_URI'], PHP_URL_PATH) : '';
    if ( ! is_string($raw) ) {
        $raw = '';
    }
    $trimmed = trim($raw, '/');
    return $trimmed !== '' ? preg_replace('#/{2,}#', '/', $trimmed) : '';
}

/**
 * public 扱いするスラッグ一覧。
 */
function ovl_auth_public_paths(): array {
    $defaults = [
        '',
        'members',
        'member-register',
        'member-gate',
        'wp-login.php',
        'property_list',
        'contact',
        'about',
        'privacy-policy',
        'sitemap',
    ];
    return apply_filters('ovl_auth_public_paths', $defaults);
}

/**
 * URLのリダイレクト先を安全に整形。
 */
function ovl_auth_sanitize_redirect($target, string $fallback = ''): string {
    $target = is_string($target) ? trim($target) : '';
    if ( $target === '' ) {
        return '';
    }
    $validated = wp_validate_redirect($target, false);
    if ( $validated === false ) {
        return $fallback;
    }
    return $validated;
}

function ovl_auth_current_url(): string {
    $request = isset($_SERVER['REQUEST_URI']) ? wp_unslash((string) $_SERVER['REQUEST_URI']) : '';
    $url = $request !== '' ? home_url($request) : home_url('/');
    $sanitized = ovl_auth_sanitize_redirect($url, home_url('/'));
    return $sanitized !== '' ? $sanitized : home_url('/');
}

function ovl_auth_default_redirect_target(): string {
    if ( is_admin() ) {
        return admin_url();
    }
    $path = ovl_auth_request_path();
    if ( $path === '' ) {
        return home_url('/');
    }
    if ( ovl_auth_is_login_path($path) || $path === 'members' ) {
        return home_url('/');
    }
    $url = home_url('/' . ltrim($path, '/'));
    $sanitized = ovl_auth_sanitize_redirect($url, home_url('/'));
    return $sanitized !== '' ? $sanitized : home_url('/');
}

function ovl_auth_is_login_path(string $path): bool {
    return $path === 'wp-login.php' || $path === 'login';
}

function ovl_auth_is_members_page(): bool {
    return function_exists('is_page') && is_page('members');
}

function ovl_auth_is_property_list_page(): bool {
    if ( function_exists('is_page') && is_page('property_list') ) {
        return true;
    }
    $path = ovl_auth_request_path();
    return $path === 'property_list';
}

function ovl_auth_is_member_gate_request(): bool {
    if ( function_exists('is_page') && is_page('member-gate') ) {
        return true;
    }
    $path = ovl_auth_request_path();
    return $path === 'member-gate' || strpos($path, 'member-gate/') === 0;
}

function ovl_auth_is_admin_like_url(string $url): bool {
    $path = (string) wp_parse_url($url, PHP_URL_PATH);
    return strpos($path, '/wp-admin') === 0;
}

function ovl_auth_should_use_native_login(string $redirect = ''): bool {
    if ( is_admin() ) {
        return true;
    }
    $path = ovl_auth_request_path();
    if ( $path === 'wp-admin' || strpos($path, 'wp-admin/') === 0 ) {
        return true;
    }
    if ( $redirect !== '' && ovl_auth_is_admin_like_url($redirect) ) {
        return true;
    }
    return false;
}

function ovl_auth_native_login_url(string $redirect = '', bool $force_reauth = false): string {
    $url = site_url('wp-login.php', 'login');
    $redirect = ovl_auth_sanitize_redirect($redirect, '');
    if ( $redirect !== '' ) {
        $url = add_query_arg('redirect_to', rawurlencode($redirect), $url);
    }
    if ( $force_reauth ) {
        $url = add_query_arg('reauth', '1', $url);
    }
    return $url;
}

function ovl_login_url(string $redirect_to = '', bool $force_reauth = false): string {
    $redirect = ovl_auth_sanitize_redirect($redirect_to, '');
    if ( $redirect === '' ) {
        $redirect = ovl_auth_default_redirect_target();
    }
    $url = home_url(OVL_LOGIN_PAGE);
    if ( $redirect ) {
        $url = add_query_arg('redirect_to', rawurlencode($redirect), $url);
    }
    if ( $force_reauth ) {
        $url = add_query_arg('reauth', '1', $url);
    }
    return $url;
}

function ovl_register_url(string $redirect_to = ''): string {
    $redirect = ovl_auth_sanitize_redirect($redirect_to, '');
    if ( $redirect === '' ) {
        $redirect = ovl_auth_default_redirect_target();
    }
    $url = home_url(OVL_REGISTER_PAGE);
    if ( $redirect ) {
        $url = add_query_arg('redirect_to', rawurlencode($redirect), $url);
    }
    return $url;
}

function ovl_member_gate_url(string $redirect_to): string {
    $redirect = ovl_auth_sanitize_redirect($redirect_to, home_url('/'));
    if ( $redirect === '' ) {
        $redirect = home_url('/');
    }
    return add_query_arg('redirect_to', rawurlencode($redirect), home_url(OVL_MEMBER_GATE_PAGE));
}

add_filter('login_url', function ($login_url, $redirect, $force_reauth) {
    $redirect = is_string($redirect) ? $redirect : '';
    if ( ovl_auth_should_use_native_login($redirect) ) {
        return ovl_auth_native_login_url($redirect, (bool) $force_reauth);
    }
    return ovl_login_url($redirect, (bool) $force_reauth);
}, 20, 3);

add_filter('login_redirect', function ($redirect_to, $requested_redirect_to, $user) {
    $candidate = '';
    if ( ! empty($_REQUEST['redirect_to']) ) {
        $candidate = ovl_auth_sanitize_redirect(wp_unslash($_REQUEST['redirect_to']), '');
    }
    if ( $candidate === '' && $redirect_to ) {
        $candidate = ovl_auth_sanitize_redirect($redirect_to, '');
    }

    if ( $candidate !== '' ) {
        return $candidate;
    }

    if ( $user instanceof WP_User && user_can($user, 'manage_options') ) {
        return admin_url();
    }

    return home_url('/');
}, 20, 3);

function ovl_auth_logout_from_admin(): bool {
    if ( is_admin() ) {
        return true;
    }
    if ( ! empty($_REQUEST['redirect_to']) && ovl_auth_is_admin_like_url((string) wp_unslash($_REQUEST['redirect_to'])) ) {
        return true;
    }
    if ( ! empty($_SERVER['HTTP_REFERER']) && ovl_auth_is_admin_like_url((string) wp_unslash($_SERVER['HTTP_REFERER'])) ) {
        return true;
    }
    return false;
}

function ovl_auth_resolve_front_logout_target($requested = ''): string {
    $home = home_url('/');
    if ( ! empty($_REQUEST['redirect_to']) ) {
        $requested = wp_unslash($_REQUEST['redirect_to']);
    } elseif ( empty($requested) && ! empty($_SERVER['HTTP_REFERER']) ) {
        $requested = wp_unslash($_SERVER['HTTP_REFERER']);
    }

    $target = ovl_auth_sanitize_redirect($requested, $home);
    if ( $target === '' ) {
        return $home;
    }

    if ( ovl_auth_is_login_path(trim((string) wp_parse_url($target, PHP_URL_PATH), '/')) ) {
        return $home;
    }
    if ( ovl_auth_is_members_url($target) ) {
        return $home;
    }
    return $target;
}

add_filter('logout_redirect', function ($redirect_to, $requested_redirect_to, $user) {
    if ( ovl_auth_logout_from_admin() ) {
        return ovl_auth_native_login_url();
    }
    return ovl_auth_resolve_front_logout_target($requested_redirect_to);
}, 20, 3);

add_filter('wpmem_logout_redirect', function ($redirect) {
    if ( ovl_auth_logout_from_admin() ) {
        return ovl_auth_native_login_url();
    }
    return ovl_auth_resolve_front_logout_target($redirect);
}, 20);

add_filter('members_is_private_page', function ($is_private) {
    if ( is_admin() ) {
        return $is_private;
    }

    if ( function_exists('is_page') && is_page(['members', 'member-gate', 'member-register', 'property_list']) ) {
        return false;
    }

    $path = ovl_auth_request_path();
    if ( in_array($path, ['members', 'member-gate', 'member-register', 'wp-login.php', 'property_list'], true) ) {
        return false;
    }

    return $is_private;
}, 20);

add_filter('wpmem_is_restricted', function ($is_restricted) {
    if ( is_admin() ) {
        return $is_restricted;
    }
    if ( ovl_auth_is_members_page() ) {
        return false;
    }
    if ( ovl_auth_is_property_list_page() ) {
        return false;
    }
    if ( is_front_page() || is_home() ) {
        return false;
    }
    return $is_restricted;
}, 50);

add_action('template_redirect', function () {
    if ( ovl_auth_is_members_page() || ovl_auth_is_member_gate_request() ) {
        if ( function_exists('members_please_log_in') ) {
            remove_action('template_redirect', 'members_please_log_in', 0);
        }
        global $wpmem;
        if ( isset($wpmem) && is_object($wpmem) ) {
            remove_filter('the_content', [$wpmem, 'the_content'], 5);
        }
        if ( function_exists('members_login_redirect') ) {
            remove_filter('login_redirect', 'members_login_redirect', 9);
        }
        if ( function_exists('members_login_form_bottom') ) {
            remove_filter('login_form_bottom', 'members_login_form_bottom');
        }
    }
}, 9);

add_action('template_redirect', function () {
    if ( is_user_logged_in() ) {
        return;
    }

    if ( ! ovl_auth_is_property_list_page() ) {
        return;
    }

    if ( function_exists('members_please_log_in') ) {
        remove_action('template_redirect', 'members_please_log_in', 0);
    }

    if ( function_exists('remove_action') ) {
        remove_action('template_redirect', 'wpmem_redirect_to_login', 10);
        remove_action('template_redirect', 'wpmem_wp_redirect', 10);
        remove_action('template_redirect', 'wpmem_block_redirect', 10);
    }

    remove_filter('the_content', 'wpmem_securify', 9);
    remove_filter('get_the_excerpt', 'wpmem_securify', 9);
}, 5);

add_action('template_redirect', function () {
    if ( ! ovl_auth_is_members_page() ) {
        return;
    }

    if ( ! is_user_logged_in() ) {
        return;
    }

    $target = '';
    if ( ! empty($_GET['redirect_to']) ) {
        $target = ovl_auth_sanitize_redirect(wp_unslash($_GET['redirect_to']), '');
    }
    if ( $target === '' && ! empty($_SERVER['HTTP_REFERER']) ) {
        $target = ovl_auth_sanitize_redirect(wp_unslash($_SERVER['HTTP_REFERER']), '');
    }
    if ( $target === '' || ovl_auth_is_members_url($target) ) {
        $target = home_url('/');
    }

    wp_safe_redirect($target, 302);
    exit;
}, 50);

add_filter('the_content', function ($content) {
    if ( ! ovl_auth_is_members_page() ) {
        return $content;
    }

    $page_id  = get_queried_object_id();
    $tpl_slug = $page_id ? get_page_template_slug($page_id) : '';
    if ( $tpl_slug === 'page-members' ) {
        return $content;
    }

    if ( stripos($content, 'wpmem_login') !== false || stripos($content, '[wpmem_form') !== false ) {
        return $content;
    }

    $form = do_shortcode('[wpmem_form login]');
    if ( stripos($form, '<form') !== false ) {
        $intro = '<p>ご登録済みのメールアドレスとパスワードでログインしてください。</p>';
        return $intro . $form;
    }

    return $content;
}, 20);

function ovl_auth_should_ignore_request(): bool {
    if ( is_admin() ) {
        return true;
    }
    if ( defined('REST_REQUEST') && REST_REQUEST ) {
        return true;
    }
    if ( function_exists('wp_doing_ajax') && wp_doing_ajax() ) {
        return true;
    }
    if ( function_exists('wp_doing_cron') && wp_doing_cron() ) {
        return true;
    }
    if ( is_feed() ) {
        return true;
    }
    return false;
}

function ovl_auth_is_public_request(): bool {
    if ( is_front_page() || is_home() ) {
        return true;
    }
    $path = ovl_auth_request_path();
    if ( $path === '' ) {
        return true;
    }
    foreach ( ovl_auth_public_paths() as $public ) {
        if ( $path === $public ) {
            return true;
        }
    }
    if ( strpos($path, 'wp-json') === 0 || strpos($path, 'feed') === 0 ) {
        return true;
    }
    return false;
}

function ovl_auth_requires_membership(): bool {
    if ( is_singular('property') ) {
        return true;
    }
    $path = ovl_auth_request_path();
    if ( $path === '' ) {
        return false;
    }
    if ( $path === 'property_list' ) {
        return false;
    }
    if ( $path === 'members' ) {
        return false;
    }
    if ( strpos($path, 'members/') === 0 ) {
        return true;
    }
    return false;
}

add_action('template_redirect', function () {
    if ( is_user_logged_in() ) {
        return;
    }
    if ( ovl_auth_should_ignore_request() ) {
        return;
    }
    if ( ovl_auth_is_public_request() ) {
        return;
    }
    if ( ! ovl_auth_requires_membership() ) {
        return;
    }

    $target = ovl_auth_current_url();
    wp_safe_redirect(ovl_member_gate_url($target), 302);
    exit;
}, 100);

add_action('init', function () {
    $page = get_page_by_path('members');
    if ( ! $page ) {
        return;
    }
    $current = get_post_meta($page->ID, '_wp_page_template', true);
    if ( $current !== 'page-members' ) {
        update_post_meta($page->ID, '_wp_page_template', 'page-members');
    }
});

function ovl_auth_is_members_url(string $url): bool {
    $path = trim((string) wp_parse_url($url, PHP_URL_PATH), '/');
    return $path === 'members' || strpos($path, 'members/') === 0;
}

if ( ! function_exists('ovl_is_member_gate') ) {
    function ovl_is_member_gate(): bool {
        return ovl_auth_is_member_gate_request();
    }
}
